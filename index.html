<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF-SL Data Diagnostics Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #ffffff; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; padding: 20px; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        .upload-section { background: #f8f9fa; padding: 2rem; border-radius: 8px; border: 2px dashed #004080; text-align: center; margin: 1.5rem 0; }
        .upload-section:hover { border-color: #0056b3; background: #e7f3ff; }
        .upload-section h3 { color: #004080; margin-bottom: 1rem; font-size: 18px; font-weight: 700; }
        .file-input-wrapper { display: inline-block; cursor: pointer; background: #004080; color: white; padding: 14px 24px; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin-top: 1rem; }
        .file-input-wrapper:hover { background: #0056b3; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
        .section-title { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin: 1.5rem 0; }
        .stats-card { background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #004080; }
        .stats-card h4 { color: #666; font-size: 11px; margin-bottom: 0.5rem; text-transform: uppercase; }
        .stats-card .metric-value { font-size: 1.6rem; color: #004080; font-weight: 700; }
        .stats-card p { color: #666; font-size: 11px; }
        .stats-card.warning .metric-value { color: #dc3545; }
        .stats-card.success .metric-value { color: #28a745; }
        .btn { padding: 14px 24px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', sans-serif; margin: 5px; }
        .btn-primary { background: #004080; color: #ffffff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #ffffff; color: #004080; }
        .btn-secondary:hover { background: #004080; color: #ffffff; }
        .btn-gold { background: #ffc107; color: #000000; border-color: #ffc107; }
        .btn-gold:hover { background: #e0a800; }
        .btn-success { background: #28a745; color: #ffffff; border-color: #28a745; }
        .btn-success:hover { background: #218838; }
        .alert { padding: 1rem; border-radius: 6px; margin: 1rem 0; font-weight: 500; }
        .alert-success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .alert-error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .alert-info { background: #e7f3ff; border: 2px solid #004080; color: #004080; }
        .hidden { display: none !important; }
        .config-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 2px solid #004080; margin: 1rem 0; }
        .config-card h4 { color: #004080; margin-bottom: 1rem; font-size: 16px; font-weight: 700; }
        .loading-spinner { border: 4px solid #e7f3ff; border-top: 4px solid #004080; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; }
        .table-container { max-height: 500px; overflow: auto; border: 2px solid #004080; border-radius: 6px; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .results-table th { background: #004080; color: #ffffff; padding: 0.75rem; text-align: left; font-weight: 700; position: sticky; top: 0; }
        .results-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #ddd; }
        .results-table tr:nth-child(even) { background: #f8f9fa; }
        .results-table tr:hover { background: #e7f3ff; }
        .column-card { background: #ffffff; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .column-card.has-issues { border-color: #dc3545; }
        .column-card.no-issues { border-color: #28a745; }
        .column-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .column-header:hover { background: #f8f9fa; }
        .column-header.numeric { background: #e7f3ff; border-bottom: 2px solid #004080; }
        .column-header.categorical { background: #fff3cd; border-bottom: 2px solid #ffc107; }
        .column-name { font-size: 16px; font-weight: 700; color: #004080; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-left: 8px; }
        .badge-numeric { background: #004080; color: #fff; }
        .badge-categorical { background: #ffc107; color: #000; }
        .badge-clean { background: #28a745; color: #fff; }
        .badge-issues { background: #dc3545; color: #fff; }
        .column-body { padding: 1.5rem; display: none; }
        .column-body.expanded { display: block; }
        .expand-icon { font-size: 20px; color: #004080; transition: transform 0.3s; }
        .expand-icon.rotated { transform: rotate(180deg); }
        .issue-box { background: #f8d7da; border: 2px solid #dc3545; border-radius: 6px; padding: 1rem; margin: 0.5rem 0; }
        .issue-box h5 { color: #721c24; margin-bottom: 0.5rem; }
        .value-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 0.5rem 0; }
        .value-chip { background: #e7f3ff; border: 1px solid #004080; padding: 4px 10px; border-radius: 15px; font-size: 12px; }
        .value-chip .count { background: #004080; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: 5px; }
        .value-chip.bad { background: #f8d7da; border-color: #dc3545; }
        .value-chip.bad .count { background: #dc3545; }
        .case-group { background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .stat-item { background: #f8f9fa; padding: 0.5rem; border-radius: 6px; text-align: center; border: 1px solid #ddd; }
        .stat-item .label { font-size: 10px; color: #666; text-transform: uppercase; }
        .stat-item .value { font-size: 16px; font-weight: 700; color: #004080; }
        .tabs { display: flex; border-bottom: 2px solid #004080; margin-bottom: 1rem; }
        .tab { padding: 12px 24px; cursor: pointer; font-weight: 700; color: #004080; border: 2px solid transparent; border-bottom: none; margin-bottom: -2px; }
        .tab:hover { background: #e7f3ff; }
        .tab.active { background: #004080; color: #fff; border-color: #004080; border-radius: 6px 6px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>DATA DIAGNOSTICS TOOL</h1>
            <p class="subtitle">Quick Data Quality Check | Case Variations & Invalid Values</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <div id="alertContainer"></div>

                <!-- Upload Section -->
                <div id="uploadSection">
                    <div class="upload-section">
                        <h3>üìÅ UPLOAD YOUR DATA FILE</h3>
                        <p>Upload a CSV or Excel file to run quick diagnostics</p>
                        <label class="file-input-wrapper">
                            Choose Data File
                            <input type="file" id="dataFileInput" accept=".csv,.xlsx,.xls">
                        </label>
                        <div id="dataFileName" style="margin-top: 10px; color: #28a745; font-weight: 700;"></div>
                    </div>

                    <div id="uploadProgress" class="hidden">
                        <div class="loading-spinner"></div>
                        <p style="text-align: center;">Processing your file...</p>
                    </div>

                    <div class="config-card">
                        <h4>üîç What This Tool Checks</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem;">
                            <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #004080;">
                                <h5 style="color: #004080; margin-bottom: 0.5rem;">üìä NUMERIC COLUMNS</h5>
                                <p style="font-size: 13px; margin-bottom: 0.5rem;"><strong>Definition:</strong> ALL values must be numbers or NA</p>
                                <ul style="font-size: 13px; padding-left: 1.2rem; line-height: 1.8;">
                                    <li>Count of valid numbers</li>
                                    <li>Count of NA/missing values</li>
                                    <li>If ANY text exists ‚Üí Categorical</li>
                                </ul>
                            </div>
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h5 style="color: #856404; margin-bottom: 0.5rem;">üè∑Ô∏è CATEGORICAL COLUMNS</h5>
                                <p style="font-size: 13px; margin-bottom: 0.5rem;"><strong>Definition:</strong> Contains any text values</p>
                                <ul style="font-size: 13px; padding-left: 1.2rem; line-height: 1.8;">
                                    <li>List of unique values</li>
                                    <li><strong>Flags case variations</strong></li>
                                    <li>e.g., "January" vs "january" ‚ö†Ô∏è</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Section -->
                <div id="processingSection" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">‚è≥</span>
                        <span class="section-title">PROCESSING</span>
                    </div>
                    <div class="config-card" style="text-align: center;">
                        <div class="loading-spinner"></div>
                        <p id="processingStatus" style="margin-top: 1rem; font-weight: 700; color: #004080;">Analyzing columns...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <div class="section-header">
                        <span class="section-icon">üìã</span>
                        <span class="section-title">DIAGNOSTIC RESULTS</span>
                    </div>

                    <div class="stats-grid" id="overallStats"></div>

                    <div id="summaryBox"></div>

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('numeric')">üìä Numeric</div>
                        <div class="tab" onclick="switchTab('mixed')">üîß Fix Mixed</div>
                        <div class="tab" onclick="switchTab('categorical')">üè∑Ô∏è Categorical</div>
                        <div class="tab" onclick="switchTab('issues')">‚ö†Ô∏è Case Issues</div>
                    </div>

                    <div id="numericTab" class="tab-content active"></div>
                    <div id="mixedTab" class="tab-content"></div>
                    <div id="categoricalTab" class="tab-content"></div>
                    <div id="issuesTab" class="tab-content"></div>

                    <div style="text-align: center; margin: 2rem 0; padding: 1.5rem; background:#f8f9fa; border-radius:8px; border:2px solid #004080;">
                        <p style="margin-bottom:1rem; color:#004080;"><strong>Ready to clean your data?</strong> Review your selections above, then click the button below.</p>
                        <button class="btn btn-gold" onclick="applyFixesAndDownload()" style="font-size:16px; padding:16px 32px;">üîß Apply Selected Fixes & Download Cleaned Data</button>
                    </div>
                    <div style="text-align: center; margin: 1rem 0;">
                        <button class="btn btn-success" onclick="downloadReport()">üì• Download Report (Excel)</button>
                        <button class="btn btn-primary" onclick="downloadIssuesCSV()">üì• Download Issues (CSV)</button>
                        <button class="btn btn-secondary" onclick="resetAll()">Start Over</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">National Malaria Control Programme</p>
            <p>Ministry of Health and Sanitation, Sierra Leone</p>
            <p style="font-size: 10px;">¬© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <script>
        let rawData = null;
        let cleanedData = null;
        let columns = [];
        let results = { numeric: {}, categorical: {}, mixed: {}, issues: [] };
        let fileName = '';
        let corrections = { replacements: {}, deletions: {} }; // Track corrections to apply

        // Valid NA values
        const NA_VALUES = ['', 'na', 'n/a', 'null', 'none', '-', '.', 'missing', 'undefined', 'nil', '#n/a', '#na'];

        document.getElementById('dataFileInput').addEventListener('change', handleFileUpload);

        function showAlert(msg, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            document.getElementById('uploadProgress').classList.remove('hidden');

            if (ext === 'csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: r => {
                        rawData = r.data;
                        columns = Object.keys(rawData[0] || {});
                        document.getElementById('dataFileName').textContent = `‚úì ${fileName} (${rawData.length} rows, ${columns.length} columns)`;
                        document.getElementById('uploadProgress').classList.add('hidden');
                        runDiagnostics();
                    }
                });
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    columns = Object.keys(rawData[0] || {});
                    document.getElementById('dataFileName').textContent = `‚úì ${fileName} (${rawData.length} rows, ${columns.length} columns)`;
                    document.getElementById('uploadProgress').classList.add('hidden');
                    runDiagnostics();
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function runDiagnostics() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('processingSection').classList.remove('hidden');

            results = { numeric: {}, categorical: {}, issues: [], mixedColumns: {} };
            corrections = { replacements: {}, deletions: {} };

            setTimeout(() => {
                columns.forEach((col, i) => {
                    document.getElementById('processingStatus').textContent = `Analyzing ${i + 1}/${columns.length}: ${col}`;
                    
                    const analysis = analyzeColumnContent(col);
                    
                    if (analysis.isNumeric) {
                        // Pure numeric column
                        results.numeric[col] = {
                            validCount: analysis.numCount,
                            naCount: analysis.naCount
                        };
                    } else if (analysis.isMostlyNumeric) {
                        // Mostly numeric but has some text - offer to clean
                        results.mixedColumns[col] = {
                            numCount: analysis.numCount,
                            naCount: analysis.naCount,
                            textValues: analysis.textValues,
                            totalText: analysis.totalText
                        };
                    } else {
                        // Categorical
                        results.categorical[col] = analyzeCategorical(col);
                    }
                });

                displayResults();
            }, 50);
        }

        /**
         * Analyze column content to determine type and find issues
         */
        function analyzeColumnContent(col) {
            let numCount = 0;
            let naCount = 0;
            const textValues = new Map();
            
            for (const row of rawData) {
                const val = row[col];
                const str = String(val ?? '').trim();
                const lower = str.toLowerCase();
                
                if (NA_VALUES.includes(lower)) {
                    naCount++;
                } else if (!isNaN(parseFloat(str)) && isFinite(str)) {
                    numCount++;
                } else {
                    textValues.set(str, (textValues.get(str) || 0) + 1);
                }
            }
            
            const totalText = Array.from(textValues.values()).reduce((a, b) => a + b, 0);
            
            return {
                isNumeric: textValues.size === 0,
                numCount,
                naCount,
                textValues,
                totalText,
                isMostlyNumeric: numCount > totalText && numCount > 0
            };
        }

        /**
         * NUMERIC: Count valid numbers and NA values
         */
        function analyzeNumeric(col) {
            const result = {
                validCount: 0,
                naCount: 0
            };

            for (const row of rawData) {
                const val = row[col];
                const str = String(val ?? '').trim();
                const lower = str.toLowerCase();

                if (NA_VALUES.includes(lower)) {
                    result.naCount++;
                } else {
                    result.validCount++;
                }
            }

            return result;
        }

        /**
         * CATEGORICAL: Get unique values and flag case variations
         */
        function analyzeCategorical(col) {
            const result = {
                valueCounts: new Map(),    // exact value -> count
                caseGroups: new Map()      // lowercase -> Map(original -> count)
            };

            for (const row of rawData) {
                const val = String(row[col] ?? '');
                const lower = val.toLowerCase().trim();

                // Count exact values
                result.valueCounts.set(val, (result.valueCounts.get(val) || 0) + 1);

                // Group by lowercase for case variation detection
                if (val.trim() !== '') {
                    if (!result.caseGroups.has(lower)) {
                        result.caseGroups.set(lower, new Map());
                    }
                    const group = result.caseGroups.get(lower);
                    group.set(val, (group.get(val) || 0) + 1);
                }
            }

            // Find case variations (same lowercase, different original)
            result.caseVariations = [];
            result.caseGroups.forEach((variants, lower) => {
                if (variants.size > 1) {
                    const variantList = Array.from(variants.entries())
                        .map(([val, count]) => ({ value: val, count }))
                        .sort((a, b) => b.count - a.count);
                    
                    result.caseVariations.push({ normalized: lower, variants: variantList });

                    // Add to issues
                    results.issues.push({
                        column: col,
                        issue: 'Case variation',
                        values: variantList.map(v => `"${v.value}" (${v.count})`).join(' vs '),
                        count: variantList.reduce((sum, v) => sum + v.count, 0)
                    });
                }
            });

            // Sort values by count
            result.sortedValues = Array.from(result.valueCounts.entries())
                .map(([value, count]) => ({ value, count }))
                .sort((a, b) => b.count - a.count);

            return result;
        }

        function displayResults() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            const numCols = Object.keys(results.numeric).length;
            const mixedCols = Object.keys(results.mixedColumns).length;
            const catCols = Object.keys(results.categorical).length;
            const totalIssues = results.issues.length;
            const colsWithIssues = new Set(results.issues.map(i => i.column)).size;

            // Overall stats
            document.getElementById('overallStats').innerHTML = `
                <div class="stats-card"><h4>Total Columns</h4><div class="metric-value">${columns.length}</div></div>
                <div class="stats-card"><h4>Numeric</h4><div class="metric-value">${numCols}</div><p>Numbers + NA only</p></div>
                <div class="stats-card ${mixedCols > 0 ? 'warning' : ''}"><h4>Mixed (Fixable)</h4><div class="metric-value">${mixedCols}</div><p>Mostly numbers</p></div>
                <div class="stats-card"><h4>Categorical</h4><div class="metric-value">${catCols}</div><p>Text values</p></div>
                <div class="stats-card ${totalIssues > 0 ? 'warning' : 'success'}"><h4>Case Issues</h4><div class="metric-value">${totalIssues}</div></div>
            `;

            // Summary box
            let summaryHtml = '';
            if (mixedCols > 0 || totalIssues > 0) {
                summaryHtml = '<div class="alert alert-error">';
                if (mixedCols > 0) {
                    summaryHtml += `<strong>üîß ${mixedCols} columns have text in numeric data</strong> - Go to "Fix Mixed" tab to remove invalid values.<br>`;
                }
                if (totalIssues > 0) {
                    summaryHtml += `<strong>‚ö†Ô∏è ${totalIssues} case variations found</strong> - Go to "Categorical" tab to standardize spelling.`;
                }
                summaryHtml += '</div>';
            } else {
                summaryHtml = '<div class="alert alert-success"><strong>‚úì No Issues Found!</strong> Your data looks clean.</div>';
            }
            document.getElementById('summaryBox').innerHTML = summaryHtml;

            displayNumericTab();
            displayMixedTab();
            displayCategoricalTab();
            displayIssuesTab();

            showAlert('Diagnostics complete!', (mixedCols > 0 || totalIssues > 0) ? 'error' : 'success');
        }

        function displayNumericTab() {
            const container = document.getElementById('numericTab');
            const entries = Object.entries(results.numeric);

            if (entries.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No pure numeric columns detected. A column is numeric only if ALL values are numbers or NA.</div>';
                return;
            }

            let html = '';
            entries.forEach(([col, data]) => {
                html += `
                    <div class="column-card no-issues">
                        <div class="column-header numeric" onclick="toggleColumn(this)">
                            <div>
                                <span class="column-name">${col}</span>
                                <span class="badge badge-numeric">NUMERIC</span>
                                <span class="badge badge-clean">‚úì CLEAN</span>
                            </div>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                        <div class="column-body">
                            <div class="stats-row">
                                <div class="stat-item"><div class="label">Valid Numbers</div><div class="value">${data.validCount.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">NA/Missing</div><div class="value">${data.naCount.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">Total</div><div class="value">${(data.validCount + data.naCount).toLocaleString()}</div></div>
                            </div>
                            <p style="color:#28a745; margin-top:1rem;">‚úì All values are valid numbers or NA</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayMixedTab() {
            const container = document.getElementById('mixedTab');
            const entries = Object.entries(results.mixedColumns);

            if (entries.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><strong>‚úì No mixed columns!</strong> All numeric columns are clean.</div>';
                return;
            }

            let html = `
                <div class="alert alert-info" style="margin-bottom:1rem;">
                    <strong>üîß These columns are mostly numeric but contain some text values.</strong><br>
                    Check the text values you want to <strong>DELETE</strong> (convert to empty/NA), then click "Apply Fixes & Download".
                </div>
            `;

            entries.forEach(([col, data]) => {
                const textArray = Array.from(data.textValues.entries()).sort((a, b) => b[1] - a[1]);
                const colId = col.replace(/[^a-zA-Z0-9]/g, '_');
                
                html += `
                    <div class="column-card has-issues">
                        <div class="column-header" style="background:#ffe6e6; border-bottom:2px solid #dc3545;" onclick="toggleColumn(this)">
                            <div>
                                <span class="column-name">${col}</span>
                                <span class="badge" style="background:#dc3545; color:#fff;">MIXED</span>
                                <span class="badge badge-issues">${data.totalText} TEXT VALUES</span>
                            </div>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                        <div class="column-body expanded">
                            <div class="stats-row">
                                <div class="stat-item"><div class="label">Valid Numbers</div><div class="value">${data.numCount.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">NA/Missing</div><div class="value">${data.naCount.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">Text (Invalid)</div><div class="value" style="color:#dc3545">${data.totalText.toLocaleString()}</div></div>
                            </div>
                            
                            <div style="margin-top:1rem; padding:1rem; background:#f8f9fa; border-radius:6px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                                    <h5 style="color:#dc3545;">‚ùå Select Text Values to DELETE:</h5>
                                    <label style="font-size:12px; cursor:pointer;">
                                        <input type="checkbox" onchange="toggleAllDeletions('${colId}', '${col}', this.checked)"> Select All
                                    </label>
                                </div>
                                <div class="value-list">
                                    ${textArray.map(([val, cnt]) => `
                                        <label class="value-chip bad" style="cursor:pointer;">
                                            <input type="checkbox" class="deletion-${colId}" data-col="${col}" data-val="${val.replace(/"/g, '&quot;')}" onchange="updateDeletion('${col}', '${val.replace(/'/g, "\\'")}', this.checked)">
                                            "${val}" <span class="count">${cnt}</span>
                                        </label>
                                    `).join('')}
                                </div>
                                <p style="font-size:11px; color:#666; margin-top:0.5rem;">‚ö†Ô∏è Checked values will be replaced with empty (NA) when you apply fixes</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize empty deletions set for this column (user must select)
                corrections.deletions[col] = new Set();
            });

            container.innerHTML = html;
        }

        function toggleAllDeletions(colId, col, checked) {
            document.querySelectorAll(`.deletion-${colId}`).forEach(cb => {
                cb.checked = checked;
                const val = cb.dataset.val;
                if (checked) {
                    if (!corrections.deletions[col]) corrections.deletions[col] = new Set();
                    corrections.deletions[col].add(val);
                } else {
                    if (corrections.deletions[col]) corrections.deletions[col].delete(val);
                }
            });
        }

        function updateDeletion(col, val, checked) {
            if (!corrections.deletions[col]) corrections.deletions[col] = new Set();
            if (checked) {
                corrections.deletions[col].add(val);
            } else {
                corrections.deletions[col].delete(val);
            }
        }

        function displayCategoricalTab() {
            const container = document.getElementById('categoricalTab');
            const entries = Object.entries(results.categorical);

            if (entries.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No categorical columns detected.</div>';
                return;
            }

            let html = `
                <div class="alert alert-info" style="margin-bottom:1rem;">
                    <strong>üè∑Ô∏è For columns with case variations:</strong> Select the STANDARD spelling you want to keep. All other variations will be replaced with your chosen standard when you apply fixes.
                </div>
            `;
            
            entries.forEach(([col, data]) => {
                const hasIssues = data.caseVariations.length > 0;
                const colId = col.replace(/[^a-zA-Z0-9]/g, '_');

                html += `
                    <div class="column-card ${hasIssues ? 'has-issues' : 'no-issues'}">
                        <div class="column-header categorical" onclick="toggleColumn(this)">
                            <div>
                                <span class="column-name">${col}</span>
                                <span class="badge badge-categorical">CATEGORICAL</span>
                                <span class="badge ${hasIssues ? 'badge-issues' : 'badge-clean'}">${hasIssues ? data.caseVariations.length + ' CASE ISSUES' : '‚úì CLEAN'}</span>
                            </div>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                        <div class="column-body ${hasIssues ? 'expanded' : ''}">
                            <div class="stats-row">
                                <div class="stat-item"><div class="label">Total Rows</div><div class="value">${rawData.length.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">Unique Values</div><div class="value">${data.valueCounts.size.toLocaleString()}</div></div>
                                <div class="stat-item"><div class="label">Case Variations</div><div class="value" style="color:${hasIssues ? '#dc3545' : '#28a745'}">${data.caseVariations.length}</div></div>
                            </div>
                            
                            ${hasIssues ? `
                                <div style="margin-top:1rem; padding:1rem; background:#fff3cd; border-radius:6px; border:2px solid #ffc107;">
                                    <h5 style="color:#856404; margin-bottom:0.75rem;">‚ö†Ô∏è Select the STANDARD Spelling (others will be replaced):</h5>
                                    ${data.caseVariations.map((group, groupIdx) => `
                                        <div style="background:#fff; padding:0.75rem; border-radius:6px; margin-bottom:0.5rem; border:1px solid #ddd;">
                                            <div style="font-size:11px; color:#666; margin-bottom:0.5rem;">Variation ${groupIdx + 1}: Select which spelling to KEEP as standard</div>
                                            <div class="value-list">
                                                ${group.variants.map((v, vIdx) => `
                                                    <label class="value-chip ${vIdx === 0 ? '' : 'bad'}" style="cursor:pointer;">
                                                        <input type="radio" name="std_${colId}_${groupIdx}" value="${v.value.replace(/"/g, '&quot;')}" 
                                                            ${vIdx === 0 ? 'checked' : ''} 
                                                            onchange="updateStandardForm('${col}', ${groupIdx}, '${v.value.replace(/'/g, "\\'")}')">
                                                        "${v.value}" <span class="count">${v.count}</span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                            <p style="font-size:10px; color:#856404; margin-top:0.5rem;">‚Üí Non-selected values will be replaced with the selected standard</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div style="margin-top:1rem;">
                                <h5 style="color:#004080; margin-bottom:0.5rem;">üìä Unique Values (Top 30):</h5>
                                <div class="value-list">
                                    ${data.sortedValues.slice(0, 30).map(v => `
                                        <span class="value-chip">${v.value === '' ? '(empty)' : `"${v.value}"`} <span class="count">${v.count}</span></span>
                                    `).join('')}
                                    ${data.sortedValues.length > 30 ? `<span class="value-chip">...and ${data.sortedValues.length - 30} more</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize replacements for this column (default to first variant - most common)
                if (hasIssues) {
                    if (!corrections.replacements[col]) corrections.replacements[col] = {};
                    data.caseVariations.forEach((group, groupIdx) => {
                        const standardForm = group.variants[0].value;
                        group.variants.forEach(v => {
                            if (v.value !== standardForm) {
                                corrections.replacements[col][v.value] = standardForm;
                            }
                        });
                    });
                }
            });

            container.innerHTML = html;
        }

        function updateStandardForm(col, groupIdx, standardValue) {
            const data = results.categorical[col];
            const group = data.caseVariations[groupIdx];
            
            if (!corrections.replacements[col]) corrections.replacements[col] = {};
            
            // Update replacements: all variants in this group become the standard value
            group.variants.forEach(v => {
                if (v.value !== standardValue) {
                    corrections.replacements[col][v.value] = standardValue;
                } else {
                    // Remove if it was previously set as a replacement
                    delete corrections.replacements[col][v.value];
                }
            });
        }

        function displayIssuesTab() {
            const container = document.getElementById('issuesTab');

            if (results.issues.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><strong>‚úì No case variations found!</strong> All categorical values are consistent.</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr><th>Column</th><th>Issue</th><th>Values</th><th>Total Count</th></tr>
                        </thead>
                        <tbody>
            `;

            results.issues.forEach(issue => {
                html += `
                    <tr>
                        <td><strong>${issue.column}</strong></td>
                        <td>Case variation</td>
                        <td style="font-family:monospace; font-size:12px; max-width:400px; word-wrap:break-word;">${issue.values}</td>
                        <td>${issue.count}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function toggleColumn(header) {
            header.nextElementSibling.classList.toggle('expanded');
            header.querySelector('.expand-icon').classList.toggle('rotated');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                const tabNames = ['numeric', 'mixed', 'categorical', 'issues'];
                t.classList.toggle('active', tabNames[i] === name);
            });
            ['numeric', 'mixed', 'categorical', 'issues'].forEach(tab => {
                document.getElementById(`${tab}Tab`).classList.toggle('active', tab === name);
            });
        }

        /**
         * Apply all corrections and download cleaned data
         */
        function applyFixesAndDownload() {
            // Count fixes to apply
            let deletionCount = 0;
            let replacementCount = 0;
            
            Object.values(corrections.deletions).forEach(set => {
                deletionCount += set.size;
            });
            Object.values(corrections.replacements).forEach(obj => {
                replacementCount += Object.keys(obj).length;
            });
            
            if (deletionCount === 0 && replacementCount === 0) {
                showAlert('No fixes selected! Check the values you want to delete or the spellings you want to standardize.', 'info');
                return;
            }
            
            // Create a copy of the data and apply fixes
            const cleanedData = rawData.map(row => {
                const newRow = { ...row };
                
                // Apply deletions (text in numeric columns -> empty)
                Object.entries(corrections.deletions).forEach(([col, valuesToDelete]) => {
                    const val = String(newRow[col] ?? '').trim();
                    if (valuesToDelete.has(val)) {
                        newRow[col] = ''; // Set to empty/NA
                    }
                });
                
                // Apply replacements (case standardization)
                Object.entries(corrections.replacements).forEach(([col, replacements]) => {
                    const val = String(newRow[col] ?? '');
                    if (replacements[val]) {
                        newRow[col] = replacements[val];
                    }
                });
                
                return newRow;
            });
            
            // Count actual changes made
            let deletedCells = 0;
            let replacedCells = 0;
            rawData.forEach((row, i) => {
                columns.forEach(col => {
                    const oldVal = String(row[col] ?? '');
                    const newVal = String(cleanedData[i][col] ?? '');
                    if (oldVal !== newVal) {
                        if (newVal === '') {
                            deletedCells++;
                        } else {
                            replacedCells++;
                        }
                    }
                });
            });
            
            // Create workbook and download
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(cleanedData);
            XLSX.utils.book_append_sheet(wb, ws, 'Cleaned Data');
            
            // Add a summary sheet
            const summaryData = [
                ['DATA CLEANING SUMMARY'],
                ['Original File:', fileName],
                ['Date:', new Date().toLocaleString()],
                [''],
                ['CHANGES APPLIED'],
                ['Cells Deleted (‚Üí empty):', deletedCells],
                ['Cells Replaced (spelling):', replacedCells],
                ['Total Changes:', deletedCells + replacedCells],
                [''],
                ['DELETIONS (Text ‚Üí Empty):'],
            ];
            
            Object.entries(corrections.deletions).forEach(([col, values]) => {
                if (values.size > 0) {
                    summaryData.push([`  ${col}:`, Array.from(values).join(', ')]);
                }
            });
            
            summaryData.push(['']);
            summaryData.push(['REPLACEMENTS (Spelling Standardization):']);
            
            Object.entries(corrections.replacements).forEach(([col, replacements]) => {
                Object.entries(replacements).forEach(([from, to]) => {
                    summaryData.push([`  ${col}:`, `"${from}" ‚Üí "${to}"`]);
                });
            });
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            const outputName = fileName.replace(/\.[^.]+$/, '_CLEANED.xlsx');
            XLSX.writeFile(wb, outputName);
            
            showAlert(`‚úì Done! Deleted ${deletedCells} cells, replaced ${replacedCells} spellings. Cleaned file downloaded!`, 'success');
        }

        function downloadReport() {
            const wb = XLSX.utils.book_new();

            // Summary
            const summary = [
                ['DATA DIAGNOSTICS REPORT'],
                ['File:', fileName],
                ['Date:', new Date().toLocaleString()],
                [''],
                ['COLUMN CLASSIFICATION'],
                ['Total Columns', columns.length],
                ['Numeric Columns (numbers + NA only)', Object.keys(results.numeric).length],
                ['Mixed Columns (mostly numeric, some text)', Object.keys(results.mixedColumns).length],
                ['Categorical Columns (contains text)', Object.keys(results.categorical).length],
                [''],
                ['ISSUES'],
                ['Columns with text in numeric data', Object.keys(results.mixedColumns).length],
                ['Case Variations Found', results.issues.length],
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');

            // Issues
            if (results.issues.length > 0) {
                const issueData = [['Column', 'Issue', 'Values', 'Count']];
                results.issues.forEach(i => issueData.push([i.column, i.issue, i.values, i.count]));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(issueData), 'Case Issues');
            }

            // Numeric
            if (Object.keys(results.numeric).length > 0) {
                const numData = [['Column', 'Valid Numbers', 'NA/Missing', 'Total']];
                Object.entries(results.numeric).forEach(([col, d]) => {
                    numData.push([col, d.validCount, d.naCount, d.validCount + d.naCount]);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(numData), 'Numeric');
            }

            // Mixed columns
            if (Object.keys(results.mixedColumns).length > 0) {
                const mixedData = [['Column', 'Valid Numbers', 'NA/Missing', 'Text Values', 'Invalid Text']];
                Object.entries(results.mixedColumns).forEach(([col, d]) => {
                    const textList = Array.from(d.textValues.entries()).map(([v, c]) => `${v} (${c})`).join(', ');
                    mixedData.push([col, d.numCount, d.naCount, d.totalText, textList]);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mixedData), 'Mixed (Fixable)');
            }

            // Categorical
            if (Object.keys(results.categorical).length > 0) {
                const catData = [['Column', 'Unique Values', 'Case Variations']];
                Object.entries(results.categorical).forEach(([col, d]) => {
                    catData.push([col, d.valueCounts.size, d.caseVariations.length]);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(catData), 'Categorical');
            }

            XLSX.writeFile(wb, fileName.replace(/\.[^.]+$/, '_diagnostics.xlsx'));
            showAlert('Report downloaded!', 'success');
        }

        function downloadIssuesCSV() {
            if (results.issues.length === 0) {
                showAlert('No issues to download!', 'info');
                return;
            }
            const csv = Papa.unparse(results.issues);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName.replace(/\.[^.]+$/, '_issues.csv');
            a.click();
            showAlert('Issues CSV downloaded!', 'success');
        }

        function resetAll() {
            rawData = null;
            columns = [];
            results = { numeric: {}, categorical: {}, issues: [], mixedColumns: {} };
            corrections = { replacements: {}, deletions: {} };
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('dataFileInput').value = '';
            document.getElementById('dataFileName').textContent = '';
        }
    </script>
</body>
</html>
